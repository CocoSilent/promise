{"version":3,"file":"promise.js","sources":["../src/type.ts","../src/promise.ts"],"sourcesContent":["export type OnFulfilled = (value?: any) => void\r\nexport type OnRejected  = (reason?: any) => void\r\nexport type Executor = (OnFulfilled, OnRejected) => void\r\n\r\nexport enum PromiseState {\r\n    'PENDING',\r\n    'FULLFILLED',\r\n    'REJECTED'\r\n}","import {Executor, OnFulfilled, OnRejected, PromiseState} from './type';\r\n\r\n// 异步任务，nodejs微任务  浏览器宏任务\r\nfunction asyncTask(fun: any) {\r\n    if (process && process.nextTick) {\r\n        // microtask\r\n        process.nextTick(fun)\r\n    } else {\r\n        // macrotask\r\n        setTimeout(fun);\r\n    }\r\n}\r\n\r\nfunction resolvePromise(promise2: Promise, x: any, resolve: OnFulfilled, reject: OnRejected) {\r\n    if (promise2 === x) {\r\n        throw new TypeError('x不能等于promise2')\r\n    } else if (x instanceof Promise) {\r\n        if (x.PromiseState === PromiseState.PENDING) {\r\n            x.then((y) => {\r\n                resolvePromise(promise2, y, resolve, reject)\r\n            }, reject)\r\n        } else {\r\n            x.then(resolve, reject);\r\n        }\r\n    } else if (x !== null && (typeof x === \"object\" || typeof x === 'function')) {\r\n        let then;\r\n        try {\r\n            then = x.then;\r\n        } catch (e) {\r\n            reject(e);\r\n            return;\r\n        }\r\n        if (typeof then === 'function') {\r\n            let called = false;\r\n            try {\r\n                then.call(x,\r\n                    (y: any) => {\r\n                        if (called) {\r\n                            return\r\n                        }\r\n                        called = true;\r\n                        resolvePromise(promise2, y, resolve, reject);\r\n                    },\r\n                    (r: any) => {\r\n                        if (called) {\r\n                            return\r\n                        }\r\n                        called = true;\r\n                        reject(r);\r\n                    })\r\n            } catch (e) {\r\n                if (called) {\r\n                    return;\r\n                }\r\n                called = true;\r\n                reject(e);\r\n            }\r\n        } else {\r\n            resolve(x);\r\n        }\r\n    } else {\r\n        resolve(x);\r\n    }\r\n}\r\n\r\nexport default class Promise {\r\n    PromiseState: PromiseState;\r\n    private PromiseResult: any;\r\n    private readonly resolve: OnFulfilled\r\n    private readonly reject: OnRejected;\r\n    private readonly onFulfilledCallbacks: OnFulfilled[] = [];\r\n    private readonly onRejectedCallbacks: OnRejected[] = [];\r\n\r\n    constructor(executor: Executor) {\r\n        this.PromiseState = PromiseState.PENDING;\r\n\r\n        this.resolve = function (value: any) {\r\n            // 状态不能重复改变\r\n            if (this.PromiseState === PromiseState.PENDING) {\r\n                asyncTask(() => {\r\n                    this.PromiseState = PromiseState.FULLFILLED;\r\n                    this.PromiseResult = value;\r\n                    this.onFulfilledCallbacks.forEach(callback => callback(this.PromiseResult));\r\n                })\r\n            }\r\n        }\r\n\r\n        this.reject = function (reason: any) {\r\n            // 状态不能重复改变\r\n            if (this.PromiseState === PromiseState.PENDING) {\r\n                asyncTask(() => {\r\n                    this.PromiseState = PromiseState.REJECTED;\r\n                    this.PromiseResult = reason;\r\n                    this.onRejectedCallbacks.forEach(callback => callback(this.PromiseResult));\r\n                })\r\n            }\r\n        }\r\n\r\n        try {\r\n            executor(this.resolve.bind(this), this.reject.bind(this));\r\n        } catch (e) {\r\n            this.reject(e);\r\n        }\r\n    }\r\n\r\n    then(onFulfilled: OnFulfilled, onRejected: OnRejected) {\r\n        if (typeof onFulfilled !== 'function') {\r\n            onFulfilled = value => value;\r\n        }\r\n        if (typeof onRejected !== 'function') {\r\n            onRejected = reason => {\r\n                throw reason\r\n            };\r\n        }\r\n        const promise2 = new Promise((resolve, reject) => {\r\n            if (this.PromiseState === PromiseState.FULLFILLED) {\r\n                asyncTask(() => {\r\n                    try {\r\n                        const x = onFulfilled(this.PromiseResult);\r\n                        resolvePromise(promise2, x, resolve, reject);\r\n                    } catch (e) {\r\n                        reject(e);\r\n                    }\r\n                });\r\n            } else if (this.PromiseState === PromiseState.REJECTED) {\r\n                asyncTask(() => {\r\n                    try {\r\n                        const x = onRejected(this.PromiseResult);\r\n                        resolvePromise(promise2, x, resolve, reject);\r\n                    } catch (e) {\r\n                        reject(e);\r\n                    }\r\n                })\r\n            } else if (this.PromiseState === PromiseState.PENDING) {\r\n                this.onFulfilledCallbacks.push((value) => {\r\n                    asyncTask(() => {\r\n                        try {\r\n                            const x = onFulfilled(value);\r\n                            resolvePromise(promise2, x, resolve, reject);\r\n                        } catch (e) {\r\n                            reject(e);\r\n                        }\r\n                    })\r\n                });\r\n\r\n                this.onRejectedCallbacks.push((reason) => {\r\n                    asyncTask(() => {\r\n                        try {\r\n                            const x = onRejected(reason);\r\n                            resolvePromise(promise2, x, resolve, reject);\r\n                        } catch (e) {\r\n                            reject(e);\r\n                        }\r\n                    })\r\n                })\r\n            }\r\n        });\r\n        return promise2;\r\n    }\r\n}"],"names":["Promise"],"mappings":"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"}