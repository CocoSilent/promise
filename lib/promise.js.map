{"version":3,"file":"promise.js","sources":["../src/type.ts","../src/promise.ts"],"sourcesContent":["export type OnFulfilled = (value?: any) => void;\r\nexport type OnRejected  = (reason?: any) => void;\r\nexport type Executor = (onFulfilled:OnFulfilled, onRejected: OnRejected) => void;\r\n\r\nexport enum PromiseState {\r\n    'PENDING',\r\n    'FULLFILLED',\r\n    'REJECTED'\r\n}\r\n","import {Executor, OnFulfilled, OnRejected, PromiseState} from './type';\n\n// 异步任务，nodejs微任务  浏览器宏任务\nfunction asyncTask(fun: any) {\n    if (typeof process !== 'undefined' && process.nextTick) {\n        // microtask\n        process.nextTick(fun);\n        // queueMicrotask(fun);\n    } else {\n        // macrotask\n        // setTimeout(fun);\n        // Microtask\n        queueMicrotask(fun);\n    }\n}\n\nfunction resolvePromise(promise2: Promise, x: any, resolve: OnFulfilled, reject: OnRejected) {\n    if (promise2 === x) {\n        throw new TypeError('x不能等于promise2');\n    } else if (x instanceof Promise) {\n        if (x.PromiseState === PromiseState.PENDING) {\n            x.then((y) => {\n                resolvePromise(promise2, y, resolve, reject);\n            }, reject);\n        } else {\n            x.then(resolve, reject);\n        }\n    } else if (x !== null && (typeof x === 'object' || typeof x === 'function')) {\n        let then;\n        try {\n            then = x.then;\n        } catch (e) {\n            reject(e);\n            return;\n        }\n        if (typeof then === 'function') {\n            let called = false;\n            try {\n                then.call(x,\n                    (y: any) => {\n                        if (called) {\n                            return;\n                        }\n                        called = true;\n                        resolvePromise(promise2, y, resolve, reject);\n                    },\n                    (r: any) => {\n                        if (called) {\n                            return;\n                        }\n                        called = true;\n                        reject(r);\n                    });\n            } catch (e) {\n                if (called) {\n                    return;\n                }\n                called = true;\n                reject(e);\n            }\n        } else {\n            resolve(x);\n        }\n    } else {\n        resolve(x);\n    }\n}\n\nexport default class Promise {\n    // tslint:disable-next-line:variable-name\n    PromiseState: PromiseState;\n    // tslint:disable-next-line:variable-name\n    private PromiseResult: any;\n    private readonly resolve: OnFulfilled;\n    private readonly reject: OnRejected;\n    private readonly onFulfilledCallbacks: OnFulfilled[] = [];\n    private readonly onRejectedCallbacks: OnRejected[] = [];\n\n    constructor(executor: Executor) {\n        this.PromiseState = PromiseState.PENDING;\n\n        this.resolve = function (value: any) {\n            // 状态不能重复改变\n            if (this.PromiseState === PromiseState.PENDING) {\n                asyncTask(() => {\n                    this.PromiseState = PromiseState.FULLFILLED;\n                    this.PromiseResult = value;\n                    this.onFulfilledCallbacks.forEach(callback => callback(this.PromiseResult));\n                });\n            }\n        };\n\n        this.reject = function (reason: any) {\n            // 状态不能重复改变\n            if (this.PromiseState === PromiseState.PENDING) {\n                asyncTask(() => {\n                    this.PromiseState = PromiseState.REJECTED;\n                    this.PromiseResult = reason;\n                    this.onRejectedCallbacks.forEach(callback => callback(this.PromiseResult));\n                });\n            }\n        };\n\n        try {\n            executor(this.resolve.bind(this), this.reject.bind(this));\n        } catch (e) {\n            this.reject(e);\n        }\n    }\n\n    then(onFulfilled: OnFulfilled, onRejected?: OnRejected) {\n        if (typeof onFulfilled !== 'function') {\n            onFulfilled = value => value;\n        }\n        if (!onRejected || typeof onRejected !== 'function') {\n            onRejected = reason => {\n                throw reason;\n            };\n        }\n        const promise2 = new Promise((resolve, reject) => {\n            if (this.PromiseState === PromiseState.FULLFILLED) {\n                asyncTask(() => {\n                    try {\n                        const x = onFulfilled(this.PromiseResult);\n                        resolvePromise(promise2, x, resolve, reject);\n                    } catch (e) {\n                        reject(e);\n                    }\n                });\n            } else if (this.PromiseState === PromiseState.REJECTED) {\n                asyncTask(() => {\n                    try {\n                        const x = (onRejected as OnRejected)(this.PromiseResult);\n                        resolvePromise(promise2, x, resolve, reject);\n                    } catch (e) {\n                        reject(e);\n                    }\n                });\n            } else if (this.PromiseState === PromiseState.PENDING) {\n                this.onFulfilledCallbacks.push((value) => {\n                    asyncTask(() => {\n                        try {\n                            const x = onFulfilled(value);\n                            resolvePromise(promise2, x, resolve, reject);\n                        } catch (e) {\n                            reject(e);\n                        }\n                    });\n                });\n\n                this.onRejectedCallbacks.push((reason) => {\n                    asyncTask(() => {\n                        try {\n                            const x = (onRejected as OnRejected)(reason);\n                            resolvePromise(promise2, x, resolve, reject);\n                        } catch (e) {\n                            reject(e);\n                        }\n                    });\n                });\n            }\n        });\n        return promise2;\n    }\n\n    static resolve(value: any) {\n        return new Promise(resovle => {\n            resovle();\n        }).then(() => {\n            return value;\n        });\n    }\n\n    static reject(reason: any) {\n        return new Promise((resolve, reject) => {\n            reject(reason);\n        });\n    }\n\n    static all(promises: any) {\n        if (!promises || !promises[Symbol.iterator]) {\n            throw new TypeError('promises必须是可迭代对象');\n        }\n        const result: any[] = [];\n        let count = 0;\n        let iteratorIndex = 0;\n        return new Promise((resolve, reject) => {\n            for (const promise of promises) {\n                const index = iteratorIndex;\n                iteratorIndex = iteratorIndex + 1;\n                Promise.resolve(promise).then((value) => {\n                    count = count + 1;\n                    result[index] = value;\n                    if (count === iteratorIndex) {\n                        resolve(result);\n                    }\n                }, (reason) => {\n                    reject(reason);\n                });\n            }\n            if (iteratorIndex === 0) {\n                resolve(result);\n            }\n        });\n    }\n }\n\n\n"],"names":["Promise"],"mappings":"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"}